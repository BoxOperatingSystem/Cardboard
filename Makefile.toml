[tasks.build-xboot]
command = "cargo"
args = [
    "build",
    "-Zbuild-std=core,compiler_builtins,alloc",
    "-Zbuild-std-features=compiler-builtins-mem",
    "--bin",
    "xboot",
    "--target",
    "x86_64-unknown-uefi",
    "--out-dir",
    "Drive/EFI/BOOT",
]

[tasks.build-kernel]
command = "cargo"
args = [
    "build",
    "-Zbuild-std=core,compiler_builtins,alloc",
    "-Zbuild-std-features=compiler-builtins-mem",
    "--bin",
    "kernel",
    "--target",
    "x86_64-kernel-tungsten.json",
    "--out-dir",
    "Drive/System",
]

[tasks.build-xboot-release]
command = "cargo"
args = [
    "build",
    "-Zbuild-std=core,compiler_builtins,alloc",
    "-Zbuild-std-features=compiler-builtins-mem",
    "--bin",
    "xboot",
    "--target",
    "x86_64-unknown-uefi",
    "--out-dir",
    "Drive/EFI/BOOT",
    "--release",
]

[tasks.build-kernel-release]
command = "cargo"
args = [
    "build",
    "-Zbuild-std=core,compiler_builtins,alloc",
    "-Zbuild-std-features=compiler-builtins-mem",
    "--bin",
    "kernel",
    "--target",
    "x86_64-kernel-tungsten.json",
    "--out-dir",
    "Drive/System",
    "--release",
]

[tasks.make-tkcache]
command = "cargo"
args = ["run", "--example", "tkcache_builder", "--release"]

[tasks.make-boot-exts]
command = "cargo"
args = ["make", "--cwd", "Extensions", "make"]

[tasks.make-boot-exts-release]
command = "cargo"
args = ["make", "--cwd", "Extensions", "make-release"]

[tasks.make]
dependencies = ["build-xboot", "build-kernel", "make-boot-exts", "make-tkcache"]

[tasks.make-release]
dependencies = [
    "build-xboot-release",
    "build-kernel-release",
    "make-boot-exts-release",
    "make-tkcache",
]

[tasks.run]
command = "qemu-system-x86_64"
args = [
    "-M",
    "q35",
    "-m",
    "1G",
    "-drive",
    "if=pflash,format=raw,readonly=on,unit=0,file=${@}/OVMF_CODE.fd",
    "-drive",
    "if=pflash,format=raw,unit=1,file=${@}/OVMF_VARS.fd",
    "-hda",
    "fat:rw:Drive",
    "-serial",
    "stdio",
    "-audiodev",
    "coreaudio,id=audio,out.frequency=48000",
    "-device",
    "ac97,audiodev=audio",
]
dependencies = ["make"]

[tasks.run-release]
command = "qemu-system-x86_64"
args = [
    "-M",
    "q35",
    "-m",
    "1G",
    "-drive",
    "if=pflash,format=raw,readonly=on,unit=0,file=${@}/OVMF_CODE.fd",
    "-drive",
    "if=pflash,format=raw,unit=1,file=${@}/OVMF_VARS.fd",
    "-hda",
    "fat:rw:Drive",
    "-audiodev",
    "coreaudio,id=audio,out.frequency=48000",
    "-device",
    "ac97,audiodev=audio",
]
dependencies = ["make-release"]

[config]
default_to_workspace = false
